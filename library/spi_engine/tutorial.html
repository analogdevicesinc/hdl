<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SPI Engine Tutorial - PulSAR-ADC &#8212; HDL  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8e8a900e" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.min.css?v=cf8483f0" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="https://wavedrom.com/skins/default.js"></script>
    <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script defer="" src="../../_static/app.umd.js?v=96350458"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../../_static/icon.svg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="AMD Xilinx Specific IPs" href="../xilinx/index.html" />
    <link rel="prev" title="SPI Engine Pipeline Delays" href="pipeline-delays.html" />
   
  
    <meta name="robots" content="noindex">
  
  


<style>
  body {
    
  }

  body.dark {
    
  }

  @media (prefers-color-scheme: dark) {
    body:not(.light) {
      
    }
  }
</style>
  </head><body>
  <input type="checkbox" id="input-show-toc">
  <input type="checkbox" id="input-show-localtoc">
  <header>
    <div class="header">
      <div id="left">
        <label id="show-sidebar" for="input-show-toc" title="Show/hide index"></label>
      </div>
      <div id="right">
        <span>
          <a id="logo-org" href="https://analog.com"></a>
              <a id="no-logo" href="../../index.html">
                HDL
              </a>
        </span>
        <span class="reverse">
          <label id="show-localtoc" for="input-show-localtoc" title="Show/hide contents"></label>
        </span>
      </div>
    </div>
    <div class="repotoc-tree">
      <root>
  <a href="../../../documentation/eval/index.html">Evaluation Boards</a>
  <a href="../../../documentation/university/index.html">University Program</a>
  <a href="../../index.html" class="current">HDL</a>
  <a href="../../../no-OS/index.html">no-OS</a>
  <a href="../../../pyadi-iio/index.html">pyadi-iio</a>
  <a href="../../../precision-converters-firmware/index.html">Precision Converters Firmware</a>
  <a href="../../../PrecisionToolbox/index.html">Precision Toolbox</a>
</root>

    </div>
  </header>

    <div class="localtoc">
      <div class="tocwrapper">
        <div>
          <div class="localtoc-header">On this page</div>
          <a id="scroll-up" href="#top-anchor" title="Back to top"></a>
        </div>
        <nav>
          <ul>
<li><a class="reference internal" href="#">SPI Engine Tutorial - PulSAR-ADC</a><ul>
<li><a class="reference internal" href="#evaluating-the-target-device">Evaluating the target device</a></li>
<li><a class="reference internal" href="#spi-engine-hierarchy-instantiation">SPI Engine hierarchy instantiation</a></li>
<li><a class="reference internal" href="#spi-engine-reference-clock">SPI Engine reference clock</a></li>
<li><a class="reference internal" href="#ad7984-timing-diagram">AD7984 Timing diagram</a><ul>
<li><a class="reference internal" href="#sample-rate-control">Sample rate control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dma-setup">DMA setup</a></li>
<li><a class="reference internal" href="#system-top">System Top</a></li>
<li><a class="reference internal" href="#system-constraints">System Constraints</a></li>
<li><a class="reference internal" href="#testbench">Testbench</a><ul>
<li><a class="reference internal" href="#evaluating-the-result">Evaluating the result</a></li>
</ul>
</li>
<li><a class="reference internal" href="#software-section">Software section</a></li>
</ul>
</li>
</ul>

        </nav>
      </div>
    </div>

  
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
              <a id="no-logo" href="../../index.html">
                HDL
              </a><input id="input-switch-toc" type="checkbox">
<label id="show-repotoc" for="input-switch-toc">
All content
</label>
<label id="show-toc" for="input-switch-toc">
Content on this topic
</label>
<div class="repotoc-tree">
  <root>
  <a href="../../../documentation/eval/index.html">Evaluation Boards</a>
  <a href="../../../documentation/university/index.html">University Program</a>
  <a href="../../index.html" class="current">HDL</a>
  <a href="../../../no-OS/index.html">no-OS</a>
  <a href="../../../pyadi-iio/index.html">pyadi-iio</a>
  <a href="../../../precision-converters-firmware/index.html">Precision Converters Firmware</a>
  <a href="../../../PrecisionToolbox/index.html">Precision Toolbox</a>
</root>

</div>
<div class="toc-tree">
  <html>
  <body><ul class="current">
<li class="toctree-l1"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-1" id="toctree-collapse-1"/><div class="collapse"><a class="reference internal" href="../../user_guide/index.html">User Guide</a><label for="toctree-collapse-1"><div class="icon"></div></label></div><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/git_repository.html">Git repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/releases.html">Releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/build_hdl.html">Build an HDL project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/architecture.html">HDL architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/ip_cores.html">IP cores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/porting_project.html">Porting reference designs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/customize_hdl.html">Customize HDL projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/hdl_coding_guideline.html">HDL coding guideline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/docs_guidelines.html">Documentation guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/third_party.html">Third party forks</a></li>
</ul>
</li>
<li class="toctree-l1 current"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-2" id="toctree-collapse-2" checked=""/><div class="collapse"><a class="reference internal" href="../index.html">Libraries</a><label for="toctree-collapse-2"><div class="icon"></div></label></div><ul class="current">
<li class="toctree-l2"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-2-1" id="toctree-collapse-2-1"/><div class="collapse"><a class="reference internal" href="../i3c_controller/index.html">I3C Controller</a><label for="toctree-collapse-2-1"><div class="icon"></div></label></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../i3c_controller/i3c_controller_host_interface.html">Host Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i3c_controller/i3c_controller_core.html">Core Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i3c_controller/interface.html">Interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../axi_adxcvr/index.html">AXI_ADXCVR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../axi_dmac/index.html">High-Speed DMA Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../axi_pwm_gen/index.html">AXI PWM Generator</a></li>
<li class="toctree-l2"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-2-2" id="toctree-collapse-2-2"/><div class="collapse"><a class="reference internal" href="../jesd204/index.html">JESD204 Interface Framework</a><label for="toctree-collapse-2-2"><div class="icon"></div></label></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../jesd204/axi_jesd204_tx/index.html">JESD204B/C Link Transmit Peripheral</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jesd204/axi_jesd204_rx/index.html">JESD204B/C Link Receive Peripheral</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jesd204/ad_ip_jesd204_tpl_adc/index.html">ADC JESD204B/C Transport Peripheral</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jesd204/ad_ip_jesd204_tpl_dac/index.html">DAC JESD204B/C Transport Peripheral</a></li>
</ul>
</li>
<li class="toctree-l2 current"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-2-3" id="toctree-collapse-2-3" checked=""/><div class="collapse"><a class="reference internal" href="index.html">SPI Engine</a><label for="toctree-collapse-2-3"><div class="icon"></div></label></div><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="spi_engine_execution.html">Execution Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="axi_spi_engine.html">AXI Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="spi_engine_offload.html">Offload Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="spi_engine_interconnect.html">Interconnect Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="control-interface.html">Control Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="offload-control-interface.html">Offload Control Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="spi-bus-interface.html">SPI Bus Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="instruction-format.html">Instruction Set Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="pipeline-delays.html">Pipeline Delays</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tutorial - PulSAR ADC</a></li>
</ul>
</li>
<li class="toctree-l2"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-2-4" id="toctree-collapse-2-4"/><div class="collapse"><a class="reference internal" href="../xilinx/index.html">AMD Xilinx Specific IPs</a><label for="toctree-collapse-2-4"><div class="icon"></div></label></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../xilinx/util_adxcvr/index.html">UTIL_ADXCVR</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-3" id="toctree-collapse-3"/><div class="collapse"><a class="reference internal" href="../../projects/index.html">Projects</a><label for="toctree-collapse-3"><div class="icon"></div></label></div><ul>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad4134_fmc/index.html">AD4134-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad4630_fmc/index.html">AD4630-FMC/AD4030-FMC/ADAQ4224-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad469x_fmc/index.html">AD469X-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad5766_sdz/index.html">AD5766-SDZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad7134_fmc/index.html">AD7134-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad719x_asdz/index.html">AD719X-ASDZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad738x_fmc/index.html">AD738X-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad7606x_fmc/index.html">AD7606X-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad7616_sdz/index.html">AD7616-SDZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad7768evb/index.html">AD7768-EVB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad9081_fmca_ebz/index.html">AD9081-FMCA-EBZ/AD9082-FMCA-EBZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad9434_fmc/index.html">AD9434-FMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/ad9783_ebz/index.html">AD9783-EBZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/adaq7980_sdz/index.html">ADAQ7980-SDZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/cn0363/index.html">CN0363</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/cn0540/index.html">CN0540</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/cn0561/index.html">CN0561</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/pulsar_adc/index.html">PULSAR-ADC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/pulsar_lvds/index.html">PULSAR-LVDS</a></li>
</ul>
</li>
</ul>
</body>
</html>

</div>
        </div>
      </div>

  <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper" id="top-anchor">
          <div class="body" role="main">
            
  <section id="spi-engine-tutorial-pulsar-adc">
<span id="spi-engine-tutorial"></span><h1>SPI Engine Tutorial - PulSAR-ADC<a class="headerlink" href="#spi-engine-tutorial-pulsar-adc" title="Permalink to this heading">#</a></h1>
<p>The goal of this tutorial is to present the process of adding
<a class="reference internal" href="index.html#spi-engine"><span class="std std-ref">SPI Engine</span></a> support for an ADI precision converter or family of converters
using a few simple steps.
The target carrier is the Digilent Cora-z7s board using a PMOD connector.</p>
<section id="evaluating-the-target-device">
<h2>Evaluating the target device<a class="headerlink" href="#evaluating-the-target-device" title="Permalink to this heading">#</a></h2>
<p>The aim of this project is to provide support for a family of ADCs which come in
the form of
<a class="reference external" href="https://wiki.analog.com/resources/eval/user-guides/circuits-from-the-lab/pulsar-adc-pmods">pulsar-adc-pmods</a>.
They all share the same interface and the same PCB, the differences being found
in their performance. The table below offers a comparison between the timing
parameters of the SPI interface for these devices. Using this table we can see
how much they have in common and where the key differences are. All the values
are for 3.3V VIO since the Cora-z7s is only 3.3V capable.</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Device</p></th>
<th class="head"><p>Re
solution</p></th>
<th class="head"><p>KSPS</p></th>
<th class="head"><p>T_
SPI_SCLK
min [ns]</p></th>
<th class="head"><p>T_CONV
max [ns]</p></th>
<th class="head"><p>T_CYC
min [ns]</p></th>
<th class="head"><p>T_ACQ
min [ns]</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>AD7942</p></td>
<td><p>14</p></td>
<td><p>250</p></td>
<td><p>18</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-odd"><td><p>AD7946</p></td>
<td><p>14</p></td>
<td><p>500</p></td>
<td><p>15</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-even"><td><p>AD7988-1</p></td>
<td><p>16</p></td>
<td><p>100</p></td>
<td><p>12</p></td>
<td><p>9500</p></td>
<td><p>1000</p></td>
<td><p>500</p></td>
</tr>
<tr class="row-odd"><td><p>AD7685</p></td>
<td><p>16</p></td>
<td><p>250</p></td>
<td><p>15</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-even"><td><p>AD7687</p></td>
<td><p>16</p></td>
<td><p>250</p></td>
<td><p>10</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-odd"><td><p>AD7691</p></td>
<td><p>16</p></td>
<td><p>250</p></td>
<td><p>15</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-even"><td><p>AD7686</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>15</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>AD7693</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>15</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-even"><td><p>AD7
988-5(B)</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>12</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>AD7
988-5(C)</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>12</p></td>
<td><p>1200</p></td>
<td><p>2000</p></td>
<td><p>800</p></td>
</tr>
<tr class="row-even"><td><p>AD7980</p></td>
<td><p>16</p></td>
<td><p>1000</p></td>
<td><p>10</p></td>
<td><p>710</p></td>
<td><p>1000</p></td>
<td><p>290</p></td>
</tr>
<tr class="row-odd"><td><p>AD7983</p></td>
<td><p>16</p></td>
<td><p>1333</p></td>
<td><p>12</p></td>
<td><p>500</p></td>
<td><p>750</p></td>
<td><p>250</p></td>
</tr>
<tr class="row-even"><td><p>AD7690</p></td>
<td><p>18</p></td>
<td><p>400</p></td>
<td><p>15</p></td>
<td><p>2100</p></td>
<td><p>2500</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>AD7982</p></td>
<td><p>18</p></td>
<td><p>1000</p></td>
<td><p>12</p></td>
<td><p>710</p></td>
<td><p>1000</p></td>
<td><p>290</p></td>
</tr>
<tr class="row-even"><td><p>AD7984</p></td>
<td><p>18</p></td>
<td><p>1333</p></td>
<td><p>12</p></td>
<td><p>500</p></td>
<td><p>750</p></td>
<td><p>250</p></td>
</tr>
</tbody>
</table>
</div>
<p>The device with the most demanding timing specifications is the AD7984. It
requires the highest amount of data (18 bit) to be read in the least amount of
time (T_ACQ 250ns). The other devices will work with the same HDL by just using
different “downgraded” configurations.</p>
</section>
<section id="spi-engine-hierarchy-instantiation">
<h2>SPI Engine hierarchy instantiation<a class="headerlink" href="#spi-engine-hierarchy-instantiation" title="Permalink to this heading">#</a></h2>
<p>The SPI Engine can be implemented in two ways, either by placing and connecting
each IP individually or by using the function provided by the
<a class="icon git reference external" href="https://github.com/analogdevicesinc/hdl/blob/main/library/spi_engine/scripts/spi_engine.tcl">library/spi_engine/scripts/spi_engine.tcl</a> script.</p>
<p>Using the script ensures that the correct connections are being made and that
the IP cores will receive the correct parameter configuration since certain
parameters need to be set to the same value. The function takes the following
arguments:</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="k">proc</span><span class="w"> </span>spi_engine_create<span class="w"> </span><span class="k">{{</span><span class="nv">name</span><span class="w"> </span><span class="s2">&quot;spi_engine&quot;</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">data_width</span><span class="w"> </span><span class="mi">32</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">async_spi_clk</span><span class="w"> </span><span class="mi">1</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">num_cs</span><span class="w"> </span><span class="mi">1</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">num_sdi</span><span class="w"> </span><span class="mi">1</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">sdi_delay</span><span class="w"> </span><span class="mi">0</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">echo_sclk</span><span class="w"> </span><span class="mi">0</span><span class="k">}}</span>
</pre></div>
</div>
<p><strong>data_width</strong> will set the width of the data bus / data line used by the SPI
engine to connect to the DMA and which serves the purpose of sending ADC sample
data to the DDR memory. The data_width value will also set the maximum word
length for the SPI transfer. Valid values are are 8/16/24/32. The DMA valid
values are 16/32/64/128[…]. Since the Pulsar_ADC devices are all single SDI/SDO
and some of them require 18bit transfers, this value will be rounded to 32bit.</p>
<p><strong>async_spi_clk</strong> will chose the reference clock for the SPI Engine. Setting
this parameter to 0 will configure the hierarchy to use the axi clock (100MHz)
as the reference clock. Setting it to 1 will allow for an external reference
clock (spi_clk). Because some devices need 80MHz SCLK, a 160MHz reference clock
is required which implies an external reference.</p>
<p><strong>num_cs</strong> selects the number of CS lines.</p>
<p><strong>num_sdi</strong> selects the number of SDI lines.</p>
<p><strong>sdi_delay</strong> The latch of the SDI line can be delayed with 1, 2 or 3 SPI core
clock cycle. Needed for designs with high SCLK rate (&gt;50MHz).</p>
<p>Configuration tcl code and result below:</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span><span class="nv">$ad_hdl_dir</span><span class="o">/</span>library<span class="o">/</span>spi_engine<span class="o">/</span>scripts<span class="o">/</span>spi_engine.tcl

<span class="k">set</span><span class="w"> </span>data_width<span class="w">    </span><span class="mi">32</span>
<span class="k">set</span><span class="w"> </span>async_spi_clk<span class="w"> </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>num_cs<span class="w">        </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>num_sdi<span class="w">       </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>sdi_delay<span class="w">     </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>hier_spi_engine<span class="w"> </span>spi_pulsar_adc

<span class="nv">spi_engine_create</span><span class="w"> </span><span class="nv">$hier_spi_engine</span><span class="w"> </span><span class="nv">$data_width</span><span class="w"> </span><span class="nv">$async_spi_clk</span><span class="w"> </span><span class="nv">$num_cs</span><span class="w"> </span><span class="nv">$num_sdi</span><span class="w"> </span><span class="nv">$sdi_delay</span>
</pre></div>
</div>
<img alt="../../_images/pulsar_hdl_1.svg" class="align-center" src="../../_images/pulsar_hdl_1.svg" /></section>
<section id="spi-engine-reference-clock">
<h2>SPI Engine reference clock<a class="headerlink" href="#spi-engine-reference-clock" title="Permalink to this heading">#</a></h2>
<p>There are 3 categories of devices depending on the SPI interface clock (SCLK):
80 MHz, 50MHz (one device) and 40MHz. SCLK will be derived from the spi_clk
reference signal using an internal prescaler with this formula:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[f_{sclk} = \frac{f_{clk}}{((div + 1) * 2)}\]</div>
</div>
<p>Therefore a 160MHz reference clock will be needed for the 40 and 80MHz variants
and 100MHz for the 50MHz SCLK. The axi_clkgen IP core will be used to obtain the
160MHz which will be the default value to ensure that the design bitstream meets
timing. This IP can also be configured from software to output 100MHz.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_ip_instance</span><span class="w"> </span>axi_clkgen<span class="w"> </span>spi_clkgen
<span class="nv">ad_ip_parameter</span><span class="w"> </span>spi_clkgen<span class="w"> </span>CONFIG.CLK0_DIV<span class="w"> </span><span class="mi">5</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>spi_clkgen<span class="w"> </span>CONFIG.VCO_DIV<span class="w"> </span><span class="mi">1</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>spi_clkgen<span class="w"> </span>CONFIG.VCO_MUL<span class="w"> </span><span class="mi">8</span>
</pre></div>
</div>
<p>Clock source for IP and spi_clk connection</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_connect</span><span class="w"> </span><span class="nv">$sys_cpu_clk</span><span class="w"> </span>spi_clkgen<span class="o">/</span>clk
<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>spi_clkgen<span class="o">/</span>clk_0
<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>spi_pulsar_adc<span class="o">/</span>spi_clk
<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>axi_pulsar_adc_dma<span class="o">/</span>s_axis_aclk
</pre></div>
</div>
</section>
<section id="ad7984-timing-diagram">
<h2>AD7984 Timing diagram<a class="headerlink" href="#ad7984-timing-diagram" title="Permalink to this heading">#</a></h2>
<p>The operation mode that will be implemented using the SPI Engine in offload mode
is the <span class="math notranslate nohighlight">\(\overline{CS}\)</span> Mode, 3-Wire with Busy Indicator Serial Interface Timing (SDI High),
as shown in ,
page 18, figure 30.</p>
<p>Key timing characteristics:</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">18</span><span class="w"> </span>bit<span class="w"> </span>transfers
<span class="nv">750</span><span class="w"> </span>ns<span class="w"> </span>T_CYC
<span class="nv">500</span><span class="w"> </span>ns<span class="w"> </span>T_CONV
<span class="nv">250</span><span class="w"> </span>ns<span class="w"> </span>T_ACQ
<span class="nv">12</span><span class="w"> </span>ns<span class="w"> </span>T_SCLK<span class="w"> </span>@<span class="w"> </span><span class="o">&gt;</span><span class="mi">3</span>V<span class="w"> </span>VIO<span class="w"> </span><span class="k">(</span><span class="nv">cora</span><span class="w"> </span>pmod<span class="w"> </span>is<span class="w"> </span><span class="mi">3</span>V3<span class="k">)</span>
</pre></div>
</div>
<section id="sample-rate-control">
<h3>Sample rate control<a class="headerlink" href="#sample-rate-control" title="Permalink to this heading">#</a></h3>
<p>The T_CYC parameter is the what sets the maximum sample rate (1/750 =&gt; 1333
KSPS). To achieve precise control over the sample rate we will use a PWM
generator (AXI PWM GEN) using the spi_clk as reference. The spi_clock is used to
avoid clock domain crossing mechanisms which will introduce latency, decreasing
the overall performance of the system.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_ip_instance</span><span class="w"> </span>axi_pwm_gen<span class="w"> </span>pulsar_adc_trigger_gen
<span class="nv">ad_ip_parameter</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="w"> </span>CONFIG.PULSE_0_PERIOD<span class="w"> </span><span class="mi">120</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="w"> </span>CONFIG.PULSE_0_WIDTH<span class="w"> </span><span class="mi">1</span>

<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>ext_clk
<span class="nv">ad_connect</span><span class="w"> </span><span class="nv">$sys_cpu_clk</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>s_axi_aclk
<span class="nv">ad_connect</span><span class="w"> </span>sys_cpu_resetn<span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>s_axi_aresetn
<span class="nv">ad_connect</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>pwm_0<span class="w">  </span><span class="nv">$hier_spi_engine</span><span class="o">/</span>offload<span class="o">/</span>trigger
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/pwm_trigger_1.svg"><img alt="../../_images/pwm_trigger_1.svg" class="align-right" src="../../_images/pwm_trigger_1.svg" width="50%" /></a>
<p>Since the AXI PWM IP core is connected to the system with AXI4 Lite, the
software will be able to change the frequency of its output at any time. The
resolution of the PWM period is the reference clock period (spi_clk) providing a
wide range of options.</p>
<p>The PWM output will be used as a trigger signal for the offload IP core.</p>
<p>The CS signal will be used to drive CNV and will have the same frequency as the
PWM-trigger signal.</p>
</section>
</section>
<section id="dma-setup">
<h2>DMA setup<a class="headerlink" href="#dma-setup" title="Permalink to this heading">#</a></h2>
<p>DMA destination bus (connection to Zynq – DDR memory) shall always be 64 bit
wide AXI4 MM and source bus shall be data_width * num_sdi = 32 bit, AXI4 Stream.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_ip_instance</span><span class="w"> </span>axi_dmac<span class="w"> </span>axi_pulsar_adc_dma
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_TYPE_SRC<span class="w"> </span><span class="mi">1</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_TYPE_DEST<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.CYCLIC<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.SYNC_TRANSFER_START<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.AXI_SLICE_SRC<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.AXI_SLICE_DEST<span class="w"> </span><span class="mi">1</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_2D_TRANSFER<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_DATA_WIDTH_SRC<span class="w"> </span><span class="nv">$data_width</span><span class="w"> </span><span class="o">//</span><span class="mi">32</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_DATA_WIDTH_DEST<span class="w"> </span><span class="mi">64</span>
</pre></div>
</div>
<p>The system clock is used as destination clock and the spi_clk is used as source
clock</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>axi_pulsar_adc_dma<span class="o">/</span>s_axis_aclk
<span class="nv">ad_mem_hp1_interconnect</span><span class="w"> </span><span class="nv">$sys_cpu_clk</span><span class="w"> </span>axi_pulsar_adc_dma<span class="o">/</span>m_dest_axi
</pre></div>
</div>
</section>
<section id="system-top">
<h2>System Top<a class="headerlink" href="#system-top" title="Permalink to this heading">#</a></h2>
<p>This is a layer on top of the system_wrapper generated by Vivado used to
instantiate IO buffers, I/ODDRs or to create some custom connections which would
be harder to do in the block design. It also allows for more consistency across
projects. In this particular case we use it to place an IO buffer for the ADC
power down signal (pulsar_adc_spi_pd).</p>
</section>
<section id="system-constraints">
<h2>System Constraints<a class="headerlink" href="#system-constraints" title="Permalink to this heading">#</a></h2>
<p>The system_constr.xdc file inside the carrier folder
(/coraz7s/system_constr.xdc) is used for defining the physical FPGA pins used by
this particular project (in this case the AD7984 ADC), excluding the “common”
design for the carrier board which has a separate constraints file (i.e. DDR
pins, Ethernet, UART etc). It also contains some timing constraints specific to
the SPI Engine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create_generated_clock</span> <span class="o">-</span><span class="n">name</span> <span class="n">spi_clk</span> <span class="o">-</span><span class="n">source</span> <span class="p">[</span><span class="n">get_pins</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">CLKIN1</span> <span class="o">-</span><span class="n">of</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hier</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">spi_clkgen</span><span class="o">*</span><span class="n">i_mmcm</span><span class="p">]]</span> <span class="o">-</span><span class="n">master_clock</span> <span class="n">clk_fpga_0</span> <span class="p">[</span><span class="n">get_pins</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">CLKOUT0</span> <span class="o">-</span><span class="n">of</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hier</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">spi_clkgen</span><span class="o">*</span><span class="n">i_mmcm</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># relax the SDO path to help closing timing at high frequencies</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">setup</span> <span class="mi">8</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">data_sdo_shift_reg</span><span class="p">[</span><span class="o">*</span><span class="p">]}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">hold</span>  <span class="mi">7</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">data_sdo_shift_reg</span><span class="p">[</span><span class="o">*</span><span class="p">]}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">setup</span> <span class="mi">8</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">execution</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">left_aligned_reg</span><span class="o">*</span><span class="p">}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">hold</span>  <span class="mi">7</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">execution</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">left_aligned_reg</span><span class="o">*</span><span class="p">}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="testbench">
<h2>Testbench<a class="headerlink" href="#testbench" title="Permalink to this heading">#</a></h2>
<p>To check the overall performance of the design and also to expose any major
bugs, the system can be tested using a testbench from <a class="icon git reference external" href="https://github.com/analogdevicesinc/testbenches">ADI Testbenches repository</a>.</p>
<p>The testbench framework is designed to use the same bd.tcl as the actual project
<a class="icon git reference external" href="https://github.com/analogdevicesinc/testbenches/blob/main/pulsar_adc_pmdz/system_bd.tcl#L50">pulsar_adc_pmdz/system_bd.tcl#L50</a></p>
<p>The setup assumes the testbenches repo is cloned inside the hdl repo. To build
the testbench project simply run <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">cfg1</span></code> from the
<em>hdl/testbenches/pulsar_adc_pmdz/</em> folder. Besides exposing possible bugs,
using the testbench will provide the user with an early way of evaluating the
timing of the design. The testbench can also be a very useful tool for IP
development.</p>
<section id="evaluating-the-result">
<h3>Evaluating the result<a class="headerlink" href="#evaluating-the-result" title="Permalink to this heading">#</a></h3>
<p>Due to the limits of the SPI Engine cores, T_CYC needs to be increased slightly
over the minimum value, to ensure that the design meets the T_CONV minimum. This
will slightly lower the maximum sample rate of the design from 1.333 MSPS to
1.322 MSPS.</p>
<a class="reference internal image-reference" href="../../_images/pulsar_hdl_timing_2.png"><img alt="../../_images/pulsar_hdl_timing_2.png" src="../../_images/pulsar_hdl_timing_2.png" style="width: 100%;" /></a>
<p>Holding CS high for 500ns ensures that we always meet T_CONV minimum.</p>
<a class="reference internal image-reference" href="../../_images/pulsar_hdl_timing_3.png"><img alt="../../_images/pulsar_hdl_timing_3.png" src="../../_images/pulsar_hdl_timing_3.png" style="width: 100%;" /></a>
<p>The 250ns minimum T_ACQ is also met with a slightly higher value of 256.25ns.</p>
<a class="reference internal image-reference" href="../../_images/pulsar_hdl_timing_4.png"><img alt="../../_images/pulsar_hdl_timing_4.png" src="../../_images/pulsar_hdl_timing_4.png" style="width: 100%;" /></a>
<p>Overall the project appears to be functional and ready for the next step in
development, using software.</p>
</section>
</section>
<section id="software-section">
<h2>Software section<a class="headerlink" href="#software-section" title="Permalink to this heading">#</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This section is still under development.</p>
</div>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

          </div>
              <div class="related">
                &nbsp;
    <a href="pipeline-delays.html" title="Previous document" class="prev">SPI Engine Pipeline Delays</a>
    <a href="../xilinx/index.html" title="Next document" class="next">AMD Xilinx Specific IPs</a>
              </div>
          
        </div>
      </div>
  </div>

  <div id="vertical-border"></div>

  <label id="cancel-area-show-toc" for="input-show-toc"></label>
  <label id="cancel-area-show-localtoc" for="input-show-localtoc"></label>

  
  <form action="" method="get" class="search-area">
    <input type="text" name="q" aria-labelledby="search-documentation" value="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="search" placeholder="Search"/>
    <button value="search"></button>
    <span id="search-progress"></span>
  </form>
  
    <footer>
      &#169;2024, Analog Devices, Inc.
      
      |
      Made with <a href="https://www.sphinx-doc.org/">Sphinx</a>
      &amp; <a href="https://github.com/analogdevicesinc/doctools">Doctools</a>
      
    </footer>
  </body>
</html>
<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="AD4134-FMC HDL project" href="../../projects/ad4134_fmc/index.html" /><link rel="prev" title="SPI Engine Pipeline Delays" href="pipeline-delays.html" />

    <link rel="shortcut icon" href="../../_static/icon.svg"/><!-- Generated with Sphinx 7.1.2 and Furo 2023.09.10 -->
        <title>SPI Engine Tutorial - PulSAR-ADC - HDL, Analog Devices v0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=e974aa45" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">HDL, Analog Devices v0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">HDL, Analog Devices v0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user_guide/index.html">User Guide</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of User Guide</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/git_repository.html">Git repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/releases.html">Releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/build_hdl.html">Build an HDL project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/architecture.html">HDL architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/ip_cores.html">IP cores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/porting_project.html">Porting reference designs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/customize_hdl.html">Customize HDL projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/hdl_coding_guideline.html">HDL coding guideline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/docs_guidelines.html">Documentation guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/third_party.html">Third party forks</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../axi_dmac/index.html">High-Speed DMA Controller</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">SPI Engine</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of SPI Engine</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="spi_engine_execution.html">Execution Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="axi_spi_engine.html">AXI Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi_engine_offload.html">Offload Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi_engine_interconnect.html">Interconnect Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="control-interface.html">Control Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="offload-control-interface.html">Offload Control Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="spi-bus-interface.html">SPI Bus Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="instruction-format.html">Instruction Set Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline-delays.html">Pipeline Delays</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Tutorial - PulSAR ADC</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad4134_fmc/index.html">AD4134-FMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad469x_fmc/index.html">AD469X-FMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad5766_sdz/index.html">AD5766-SDZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad7134_fmc/index.html">AD7134-FMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad719x_asdz/index.html">AD719X-ASDZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad738x_fmc/index.html">AD738X-FMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad7616_sdz/index.html">AD7616-SDZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad9081_fmca_ebz/index.html">AD9081-FMCA-EBZ/AD9082-FMCA-EBZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad9434_fmc/index.html">AD9434-FMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/ad9783_ebz/index.html">AD9783-EBZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/adaq7980_sdz/index.html">ADAQ7980-SDZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/cn0540/index.html">CN0540</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/cn0561/index.html">CN0561</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="spi-engine-tutorial-pulsar-adc">
<span id="spi-engine-tutorial"></span><h1>SPI Engine Tutorial - PulSAR-ADC<a class="headerlink" href="#spi-engine-tutorial-pulsar-adc" title="Permalink to this heading">#</a></h1>
<p>The goal of this tutorial is to present the process of adding
<a class="reference internal" href="index.html#spi-engine"><span class="std std-ref">SPI Engine</span></a> support for an ADI precision converter or family of converters
using a few simple steps.
The target carrier is the Digilent Cora-z7s board using a PMOD connector.</p>
<section id="evaluating-the-target-device">
<h2>Evaluating the target device<a class="headerlink" href="#evaluating-the-target-device" title="Permalink to this heading">#</a></h2>
<p>The aim of this project is to provide support for a family of ADCs which come in
the form of
<a class="reference external" href="https://wiki.analog.com/resources/eval/user-guides/circuits-from-the-lab/pulsar-adc-pmods">pulsar-adc-pmods</a>.
They all share the same interface and the same PCB, the differences being found
in their performance. The table below offers a comparison between the timing
parameters of the SPI interface for these devices. Using this table we can see
how much they have in common and where the key differences are. All the values
are for 3.3V VIO since the Cora-z7s is only 3.3V capable.</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Device</p></th>
<th class="head"><p>Re
solution</p></th>
<th class="head"><p>KSPS</p></th>
<th class="head"><p>T_
SPI_SCLK
min [ns]</p></th>
<th class="head"><p>T_CONV
max [ns]</p></th>
<th class="head"><p>T_CYC
min [ns]</p></th>
<th class="head"><p>T_ACQ
min [ns]</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>AD7942</p></td>
<td><p>14</p></td>
<td><p>250</p></td>
<td><p>18</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-odd"><td><p>AD7946</p></td>
<td><p>14</p></td>
<td><p>500</p></td>
<td><p>15</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-even"><td><p>AD7988-1</p></td>
<td><p>16</p></td>
<td><p>100</p></td>
<td><p>12</p></td>
<td><p>9500</p></td>
<td><p>1000</p></td>
<td><p>500</p></td>
</tr>
<tr class="row-odd"><td><p>AD7685</p></td>
<td><p>16</p></td>
<td><p>250</p></td>
<td><p>15</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-even"><td><p>AD7687</p></td>
<td><p>16</p></td>
<td><p>250</p></td>
<td><p>10</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-odd"><td><p>AD7691</p></td>
<td><p>16</p></td>
<td><p>250</p></td>
<td><p>15</p></td>
<td><p>2200</p></td>
<td><p>4000</p></td>
<td><p>1800</p></td>
</tr>
<tr class="row-even"><td><p>AD7686</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>15</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>AD7693</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>15</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-even"><td><p>AD7
988-5(B)</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>12</p></td>
<td><p>1600</p></td>
<td><p>2000</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>AD7
988-5(C)</p></td>
<td><p>16</p></td>
<td><p>500</p></td>
<td><p>12</p></td>
<td><p>1200</p></td>
<td><p>2000</p></td>
<td><p>800</p></td>
</tr>
<tr class="row-even"><td><p>AD7980</p></td>
<td><p>16</p></td>
<td><p>1000</p></td>
<td><p>10</p></td>
<td><p>710</p></td>
<td><p>1000</p></td>
<td><p>290</p></td>
</tr>
<tr class="row-odd"><td><p>AD7983</p></td>
<td><p>16</p></td>
<td><p>1333</p></td>
<td><p>12</p></td>
<td><p>500</p></td>
<td><p>750</p></td>
<td><p>250</p></td>
</tr>
<tr class="row-even"><td><p>AD7690</p></td>
<td><p>18</p></td>
<td><p>400</p></td>
<td><p>15</p></td>
<td><p>2100</p></td>
<td><p>2500</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>AD7982</p></td>
<td><p>18</p></td>
<td><p>1000</p></td>
<td><p>12</p></td>
<td><p>710</p></td>
<td><p>1000</p></td>
<td><p>290</p></td>
</tr>
<tr class="row-even"><td><p>AD7984</p></td>
<td><p>18</p></td>
<td><p>1333</p></td>
<td><p>12</p></td>
<td><p>500</p></td>
<td><p>750</p></td>
<td><p>250</p></td>
</tr>
</tbody>
</table>
</div>
<p>The device with the most demanding timing specifications is the AD7984. It
requires the highest amount of data (18 bit) to be read in the least amount of
time (T_ACQ 250ns). The other devices will work with the same HDL by just using
different “downgraded” configurations.</p>
</section>
<section id="spi-engine-hierarchy-instantiation">
<h2>SPI Engine hierarchy instantiation<a class="headerlink" href="#spi-engine-hierarchy-instantiation" title="Permalink to this heading">#</a></h2>
<p>The SPI Engine can be implemented in two ways, either by placing and connecting
each IP individually or by using the function provided by the
<a class="reference external" href="https://github.com/analogdevicesinc/hdl/blob/main/library/spi_engine/scripts/spi_engine.tcl">library/spi_engine/scripts/spi_engine.tcl</a> script.</p>
<p>Using the script ensures that the correct connections are being made and that
the IP cores will receive the correct parameter configuration since certain
parameters need to be set to the same value. The function takes the following
arguments:</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="k">proc</span><span class="w"> </span>spi_engine_create<span class="w"> </span><span class="k">{{</span><span class="nv">name</span><span class="w"> </span><span class="s2">&quot;spi_engine&quot;</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">data_width</span><span class="w"> </span><span class="mi">32</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">async_spi_clk</span><span class="w"> </span><span class="mi">1</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">num_cs</span><span class="w"> </span><span class="mi">1</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">num_sdi</span><span class="w"> </span><span class="mi">1</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">sdi_delay</span><span class="w"> </span><span class="mi">0</span><span class="k">}</span><span class="w"> </span><span class="k">{</span><span class="nv">echo_sclk</span><span class="w"> </span><span class="mi">0</span><span class="k">}}</span>
</pre></div>
</div>
<p><strong>data_width</strong> will set the width of the data bus / data line used by the SPI
engine to connect to the DMA and which serves the purpose of sending ADC sample
data to the DDR memory. The data_width value will also set the maximum word
length for the SPI transfer. Valid values are are 8/16/24/32. The DMA valid
values are 16/32/64/128[…]. Since the Pulsar_ADC devices are all single SDI/SDO
and some of them require 18bit transfers, this value will be rounded to 32bit.</p>
<p><strong>async_spi_clk</strong> will chose the reference clock for the SPI Engine. Setting
this parameter to 0 will configure the hierarchy to use the axi clock (100MHz)
as the reference clock. Setting it to 1 will allow for an external reference
clock (spi_clk). Because some devices need 80MHz SCLK, a 160MHz reference clock
is required which implies an external reference.</p>
<p><strong>num_cs</strong> selects the number of CS lines.</p>
<p><strong>num_sdi</strong> selects the number of SDI lines.</p>
<p><strong>sdi_delay</strong> The latch of the SDI line can be delayed with 1, 2 or 3 SPI core
clock cycle. Needed for designs with high SCLK rate (&gt;50MHz).</p>
<p>Configuration tcl code and result below:</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span><span class="nv">$ad_hdl_dir</span><span class="o">/</span>library<span class="o">/</span>spi_engine<span class="o">/</span>scripts<span class="o">/</span>spi_engine.tcl

<span class="k">set</span><span class="w"> </span>data_width<span class="w">    </span><span class="mi">32</span>
<span class="k">set</span><span class="w"> </span>async_spi_clk<span class="w"> </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>num_cs<span class="w">        </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>num_sdi<span class="w">       </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>sdi_delay<span class="w">     </span><span class="mi">1</span>
<span class="k">set</span><span class="w"> </span>hier_spi_engine<span class="w"> </span>spi_pulsar_adc

<span class="nv">spi_engine_create</span><span class="w"> </span><span class="nv">$hier_spi_engine</span><span class="w"> </span><span class="nv">$data_width</span><span class="w"> </span><span class="nv">$async_spi_clk</span><span class="w"> </span><span class="nv">$num_cs</span><span class="w"> </span><span class="nv">$num_sdi</span><span class="w"> </span><span class="nv">$sdi_delay</span>
</pre></div>
</div>
<img alt="../../_images/pulsar_hdl_1.svg" class="align-center" src="../../_images/pulsar_hdl_1.svg" /></section>
<section id="spi-engine-reference-clock">
<h2>SPI Engine reference clock<a class="headerlink" href="#spi-engine-reference-clock" title="Permalink to this heading">#</a></h2>
<p>There are 3 categories of devices depending on the SPI interface clock (SCLK):
80 MHz, 50MHz (one device) and 40MHz. SCLK will be derived from the spi_clk
reference signal using an internal prescaler with this formula:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[f_{sclk} = \frac{f_{clk}}{((div + 1) * 2)}\]</div>
</div>
<p>Therefore a 160MHz reference clock will be needed for the 40 and 80MHz variants
and 100MHz for the 50MHz SCLK. The axi_clkgen IP core will be used to obtain the
160MHz which will be the default value to ensure that the design bitstream meets
timing. This IP can also be configured from software to output 100MHz.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_ip_instance</span><span class="w"> </span>axi_clkgen<span class="w"> </span>spi_clkgen
<span class="nv">ad_ip_parameter</span><span class="w"> </span>spi_clkgen<span class="w"> </span>CONFIG.CLK0_DIV<span class="w"> </span><span class="mi">5</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>spi_clkgen<span class="w"> </span>CONFIG.VCO_DIV<span class="w"> </span><span class="mi">1</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>spi_clkgen<span class="w"> </span>CONFIG.VCO_MUL<span class="w"> </span><span class="mi">8</span>
</pre></div>
</div>
<p>Clock source for IP and spi_clk connection</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_connect</span><span class="w"> </span><span class="nv">$sys_cpu_clk</span><span class="w"> </span>spi_clkgen<span class="o">/</span>clk
<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>spi_clkgen<span class="o">/</span>clk_0
<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>spi_pulsar_adc<span class="o">/</span>spi_clk
<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>axi_pulsar_adc_dma<span class="o">/</span>s_axis_aclk
</pre></div>
</div>
</section>
<section id="ad7984-timing-diagram">
<h2>AD7984 Timing diagram<a class="headerlink" href="#ad7984-timing-diagram" title="Permalink to this heading">#</a></h2>
<p>The operation mode that will be implemented using the SPI Engine in offload mode
is the <span class="math notranslate nohighlight">\(\overline{CS}\)</span> Mode, 3-Wire with Busy Indicator Serial Interface Timing (SDI High),
as shown in <a class="reference external" href="https://www.analog.com/media/en/technical-documentation/data-sheets//AD7984.pdf#[{&quot;num&quot;%3A51%2C&quot;gen&quot;%3A0}%2C{&quot;name&quot;%3A&quot;XYZ&quot;}%2C52%2C713%2C0]">AD7984 datasheet</a>,
page 18, figure 30.</p>
<p>Key timing characteristics:</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">18</span><span class="w"> </span>bit<span class="w"> </span>transfers
<span class="nv">750</span><span class="w"> </span>ns<span class="w"> </span>T_CYC
<span class="nv">500</span><span class="w"> </span>ns<span class="w"> </span>T_CONV
<span class="nv">250</span><span class="w"> </span>ns<span class="w"> </span>T_ACQ
<span class="nv">12</span><span class="w"> </span>ns<span class="w"> </span>T_SCLK<span class="w"> </span>@<span class="w"> </span><span class="o">&gt;</span><span class="mi">3</span>V<span class="w"> </span>VIO<span class="w"> </span><span class="k">(</span><span class="nv">cora</span><span class="w"> </span>pmod<span class="w"> </span>is<span class="w"> </span><span class="mi">3</span>V3<span class="k">)</span>
</pre></div>
</div>
<section id="sample-rate-control">
<h3>Sample rate control<a class="headerlink" href="#sample-rate-control" title="Permalink to this heading">#</a></h3>
<p>The T_CYC parameter is the what sets the maximum sample rate (1/750 =&gt; 1333
KSPS). To achieve precise control over the sample rate we will use a PWM
generator (AXI PWM GEN) using the spi_clk as reference. The spi_clock is used to
avoid clock domain crossing mechanisms which will introduce latency, decreasing
the overall performance of the system.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_ip_instance</span><span class="w"> </span>axi_pwm_gen<span class="w"> </span>pulsar_adc_trigger_gen
<span class="nv">ad_ip_parameter</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="w"> </span>CONFIG.PULSE_0_PERIOD<span class="w"> </span><span class="mi">120</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="w"> </span>CONFIG.PULSE_0_WIDTH<span class="w"> </span><span class="mi">1</span>

<span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>ext_clk
<span class="nv">ad_connect</span><span class="w"> </span><span class="nv">$sys_cpu_clk</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>s_axi_aclk
<span class="nv">ad_connect</span><span class="w"> </span>sys_cpu_resetn<span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>s_axi_aresetn
<span class="nv">ad_connect</span><span class="w"> </span>pulsar_adc_trigger_gen<span class="o">/</span>pwm_0<span class="w">  </span><span class="nv">$hier_spi_engine</span><span class="o">/</span>offload<span class="o">/</span>trigger
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/pwm_trigger_1.svg"><img alt="../../_images/pwm_trigger_1.svg" class="align-right" src="../../_images/pwm_trigger_1.svg" width="50%" /></a>
<p>Since the AXI PWM IP core is connected to the system with AXI4 Lite, the
software will be able to change the frequency of its output at any time. The
resolution of the PWM period is the reference clock period (spi_clk) providing a
wide range of options.</p>
<p>The PWM output will be used as a trigger signal for the offload IP core.</p>
<p>The CS signal will be used to drive CNV and will have the same frequency as the
PWM-trigger signal.</p>
</section>
</section>
<section id="dma-setup">
<h2>DMA setup<a class="headerlink" href="#dma-setup" title="Permalink to this heading">#</a></h2>
<p>DMA destination bus (connection to Zynq – DDR memory) shall always be 64 bit
wide AXI4 MM and source bus shall be data_width * num_sdi = 32 bit, AXI4 Stream.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_ip_instance</span><span class="w"> </span>axi_dmac<span class="w"> </span>axi_pulsar_adc_dma
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_TYPE_SRC<span class="w"> </span><span class="mi">1</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_TYPE_DEST<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.CYCLIC<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.SYNC_TRANSFER_START<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.AXI_SLICE_SRC<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.AXI_SLICE_DEST<span class="w"> </span><span class="mi">1</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_2D_TRANSFER<span class="w"> </span><span class="mi">0</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_DATA_WIDTH_SRC<span class="w"> </span><span class="nv">$data_width</span><span class="w"> </span><span class="o">//</span><span class="mi">32</span>
<span class="nv">ad_ip_parameter</span><span class="w"> </span>axi_pulsar_adc_dma<span class="w"> </span>CONFIG.DMA_DATA_WIDTH_DEST<span class="w"> </span><span class="mi">64</span>
</pre></div>
</div>
<p>The system clock is used as destination clock and the spi_clk is used as source
clock</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">ad_connect</span><span class="w"> </span>spi_clk<span class="w"> </span>axi_pulsar_adc_dma<span class="o">/</span>s_axis_aclk
<span class="nv">ad_mem_hp1_interconnect</span><span class="w"> </span><span class="nv">$sys_cpu_clk</span><span class="w"> </span>axi_pulsar_adc_dma<span class="o">/</span>m_dest_axi
</pre></div>
</div>
</section>
<section id="system-top">
<h2>System Top<a class="headerlink" href="#system-top" title="Permalink to this heading">#</a></h2>
<p>This is a layer on top of the system_wrapper generated by Vivado used to
instantiate IO buffers, I/ODDRs or to create some custom connections which would
be harder to do in the block design. It also allows for more consistency across
projects. In this particular case we use it to place an IO buffer for the ADC
power down signal (pulsar_adc_spi_pd).</p>
</section>
<section id="system-constraints">
<h2>System Constraints<a class="headerlink" href="#system-constraints" title="Permalink to this heading">#</a></h2>
<p>The system_constr.xdc file inside the carrier folder
(/coraz7s/system_constr.xdc) is used for defining the physical FPGA pins used by
this particular project (in this case the AD7984 ADC), excluding the “common”
design for the carrier board which has a separate constraints file (i.e. DDR
pins, Ethernet, UART etc). It also contains some timing constraints specific to
the SPI Engine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create_generated_clock</span> <span class="o">-</span><span class="n">name</span> <span class="n">spi_clk</span> <span class="o">-</span><span class="n">source</span> <span class="p">[</span><span class="n">get_pins</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">CLKIN1</span> <span class="o">-</span><span class="n">of</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hier</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">spi_clkgen</span><span class="o">*</span><span class="n">i_mmcm</span><span class="p">]]</span> <span class="o">-</span><span class="n">master_clock</span> <span class="n">clk_fpga_0</span> <span class="p">[</span><span class="n">get_pins</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">CLKOUT0</span> <span class="o">-</span><span class="n">of</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hier</span> <span class="o">-</span><span class="nb">filter</span> <span class="n">name</span><span class="o">=~*</span><span class="n">spi_clkgen</span><span class="o">*</span><span class="n">i_mmcm</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># relax the SDO path to help closing timing at high frequencies</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">setup</span> <span class="mi">8</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">data_sdo_shift_reg</span><span class="p">[</span><span class="o">*</span><span class="p">]}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">hold</span>  <span class="mi">7</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">data_sdo_shift_reg</span><span class="p">[</span><span class="o">*</span><span class="p">]}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">setup</span> <span class="mi">8</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">execution</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">left_aligned_reg</span><span class="o">*</span><span class="p">}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
<span class="n">set_multicycle_path</span> <span class="o">-</span><span class="n">hold</span>  <span class="mi">7</span> <span class="o">-</span><span class="n">to</span> <span class="p">[</span><span class="n">get_cells</span> <span class="o">-</span><span class="n">hierarchical</span> <span class="o">-</span><span class="nb">filter</span> <span class="p">{</span><span class="n">NAME</span><span class="o">=~*/</span><span class="n">execution</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">left_aligned_reg</span><span class="o">*</span><span class="p">}]</span> <span class="o">-</span><span class="kn">from</span> <span class="p">[</span><span class="n">get_clocks</span> <span class="n">spi_clk</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="testbench">
<h2>Testbench<a class="headerlink" href="#testbench" title="Permalink to this heading">#</a></h2>
<p>To check the overall performance of the design and also to expose any major
bugs, the system can be tested using a testbench from <a class="reference external" href="https://github.com/analogdevicesinc/testbenches">ADI Testbenches repository</a>.</p>
<p>The testbench framework is designed to use the same bd.tcl as the actual project
<a class="reference external" href="https://github.com/analogdevicesinc/testbenches/blob/main/pulsar_adc_pmdz/system_bd.tcl#L50">pulsar_adc_pmdz/system_bd.tcl#L50</a></p>
<p>The setup assumes the testbenches repo is cloned inside the hdl repo. To build
the testbench project simply run <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">cfg1</span></code> from the
<em>hdl/testbenches/pulsar_adc_pmdz/</em> folder. Besides exposing possible bugs,
using the testbench will provide the user with an early way of evaluating the
timing of the design. The testbench can also be a very useful tool for IP
development.</p>
<section id="evaluating-the-result">
<h3>Evaluating the result<a class="headerlink" href="#evaluating-the-result" title="Permalink to this heading">#</a></h3>
<p>Due to the limits of the SPI Engine cores, T_CYC needs to be increased slightly
over the minimum value, to ensure that the design meets the T_CONV minimum. This
will slightly lower the maximum sample rate of the design from 1.333 MSPS to
1.322 MSPS.</p>
<a class="reference internal image-reference" href="../../_images/pulsar_hdl_timing_2.png"><img alt="../../_images/pulsar_hdl_timing_2.png" src="../../_images/pulsar_hdl_timing_2.png" style="width: 100%;" /></a>
<p>Holding CS high for 500ns ensures that we always meet T_CONV minimum.</p>
<a class="reference internal image-reference" href="../../_images/pulsar_hdl_timing_3.png"><img alt="../../_images/pulsar_hdl_timing_3.png" src="../../_images/pulsar_hdl_timing_3.png" style="width: 100%;" /></a>
<p>The 250ns minimum T_ACQ is also met with a slightly higher value of 256.25ns.</p>
<a class="reference internal image-reference" href="../../_images/pulsar_hdl_timing_4.png"><img alt="../../_images/pulsar_hdl_timing_4.png" src="../../_images/pulsar_hdl_timing_4.png" style="width: 100%;" /></a>
<p>Overall the project appears to be functional and ready for the next step in
development, using software.</p>
</section>
</section>
<section id="software-section">
<h2>Software section<a class="headerlink" href="#software-section" title="Permalink to this heading">#</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This section is still under development.</p>
</div>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../projects/ad4134_fmc/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">AD4134-FMC HDL project</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="pipeline-delays.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">SPI Engine Pipeline Delays</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Analog Devices Inc
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">SPI Engine Tutorial - PulSAR-ADC</a><ul>
<li><a class="reference internal" href="#evaluating-the-target-device">Evaluating the target device</a></li>
<li><a class="reference internal" href="#spi-engine-hierarchy-instantiation">SPI Engine hierarchy instantiation</a></li>
<li><a class="reference internal" href="#spi-engine-reference-clock">SPI Engine reference clock</a></li>
<li><a class="reference internal" href="#ad7984-timing-diagram">AD7984 Timing diagram</a><ul>
<li><a class="reference internal" href="#sample-rate-control">Sample rate control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dma-setup">DMA setup</a></li>
<li><a class="reference internal" href="#system-top">System Top</a></li>
<li><a class="reference internal" href="#system-constraints">System Constraints</a></li>
<li><a class="reference internal" href="#testbench">Testbench</a><ul>
<li><a class="reference internal" href="#evaluating-the-result">Evaluating the result</a></li>
</ul>
</li>
<li><a class="reference internal" href="#software-section">Software section</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=4c0d86c8"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="https://wavedrom.com/skins/default.js"></script>
    <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>